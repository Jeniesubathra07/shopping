<div class="checkout-page container">
    @if (!orderComplete()) {
    <div class="checkout-steps">
        <div class="step" [class.active]="currentStep() >= 1" [class.complete]="currentStep() > 1">
            <div class="step-circle">1</div>
            <span>Shipping</span>
        </div>
        <div class="step-line"></div>
        <div class="step" [class.active]="currentStep() >= 2" [class.complete]="currentStep() > 2">
            <div class="step-circle">2</div>
            <span>Payment</span>
        </div>
        <div class="step-line"></div>
        <div class="step" [class.active]="currentStep() >= 3">
            <div class="step-circle">3</div>
            <span>Confirmation</span>
        </div>
    </div>

    <div class="checkout-content">
        <div class="checkout-form">
            <form [formGroup]="checkoutForm">

                @if (currentStep() === 1) {
                <div class="form-section" formGroupName="shipping">
                    <h2>Shipping Information</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label>First Name</label>
                            <input type="text" formControlName="firstName" placeholder="John">
                            @if (shippingForm?.get('firstName')?.dirty && shippingForm?.get('firstName')?.invalid) {
                            <span class="error">Required</span>
                            }
                        </div>
                        <div class="form-group">
                            <label>Last Name</label>
                            <input type="text" formControlName="lastName" placeholder="Doe">
                            @if (shippingForm?.get('lastName')?.dirty && shippingForm?.get('lastName')?.invalid) {
                            <span class="error">Required</span>
                            }
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" formControlName="email">
                        @if (shippingForm?.get('email')?.dirty && shippingForm?.get('email')?.invalid) {
                        <span class="error">Invalid email</span>
                        }
                    </div>

                    <div class="form-group">
                        <label>Address</label>
                        <input type="text" formControlName="address">
                        @if (shippingForm?.get('address')?.dirty && shippingForm?.get('address')?.invalid) {
                        <span class="error">Required</span>
                        }
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>City</label>
                            <input type="text" formControlName="city">
                            @if (shippingForm?.get('city')?.dirty && shippingForm?.get('city')?.invalid) {
                            <span class="error">Required</span>
                            }
                        </div>
                        <div class="form-group">
                            <label>ZIP Code</label>
                            <input type="text" formControlName="zip">
                            @if (shippingForm?.get('zip')?.dirty && shippingForm?.get('zip')?.invalid) {
                            <span class="error">Required</span>
                            }
                        </div>
                    </div>

                    <div class="actions">
                        <button type="button" class="btn btn-secondary" routerLink="/cart">Back to Cart</button>
                        <button type="button" class="btn btn-primary" (click)="nextStep()">Continue to Payment</button>
                    </div>
                </div>
                }

                @if (currentStep() === 2) {
                <div class="form-section" formGroupName="payment">
                    <h2>Payment Details</h2>

                    <div class="form-group">
                        <label>Name on Card</label>
                        <input type="text" formControlName="cardName">
                    </div>

                    <div class="form-group">
                        <label>Card Number</label>
                        <input type="text" formControlName="cardNumber" placeholder="0000 0000 0000 0000">
                        @if (paymentForm?.get('cardNumber')?.dirty && paymentForm?.get('cardNumber')?.invalid) {
                        <span class="error">Invalid card number (16 digits)</span>
                        }
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Expiry (MM/YY)</label>
                            <input type="text" formControlName="expiry" placeholder="MM/YY">
                        </div>
                        <div class="form-group">
                            <label>CVV</label>
                            <input type="text" formControlName="cvv" placeholder="123">
                        </div>
                    </div>

                    <div class="actions">
                        <button type="button" class="btn btn-secondary" (click)="prevStep()">Back</button>
                        <button type="button" class="btn btn-primary" (click)="placeOrder()">Place Order</button>
                    </div>
                </div>
                }

            </form>
        </div>

        <div class="order-summary">
            <h2>Order Summary</h2>
            @for (item of cartService.items(); track item.product.id) {
            <div class="summary-item">
                <div class="item-info">
                    <span class="item-name">{{ item.product.title }}</span>
                    <span class="item-qty">x{{ item.quantity }}</span>
                </div>
                <span class="item-price">${{ (item.product.price * item.quantity).toFixed(2) }}</span>
            </div>
            }
            <div class="summary-divider"></div>
            <div class="summary-row total">
                <span>Total</span>
                <span>${{ (cartService.cartTotal() * 1.08).toFixed(2) }}</span>
            </div>
        </div>
    </div>
    } @else {
    <div class="order-confirmation">
        <div class="success-icon">
            <span class="material-icons">check_circle</span>
        </div>
        <h1>Order Confirmed!</h1>
        <p>Thank you for your purchase. We've sent a confirmation email to your inbox.</p>
        <button class="btn btn-primary btn-lg" (click)="continueShopping()">Continue Shopping</button>
    </div>
    }
</div>